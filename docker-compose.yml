version: '3.8'

services:
  # --- 1. SERVIDOR TCP (Destino Final) ---
  server:
    build: 
      context: .
      dockerfile: Dockerfile.base
    container_name: tcp-server
    # Comando de inicialização: python servidor.py <PORTA_INTERNA>
    command: python servidor.py 8000
    # O servidor escuta na porta 8000 dentro da rede Docker
    
  # --- 2. PROXY TCP INTELIGENTE ---
  proxy:
    build: 
      context: .
      dockerfile: Dockerfile.base
    container_name: tcp-proxy
    # Expõe a porta 8080 para que o HOST (sua máquina) possa se conectar
    ports:
      - "8080:8080" 
    # Comando de inicialização no modo BASELINE:
    # python main.py <PROXY_IP> <PROXY_PORT> <REMOTE_HOST> <REMOTE_PORT> <POLICY_MODE>
    # O REMOTE_HOST é 'server', o nome do serviço
    command: python main.py 0.0.0.0 8080 server 8000 none
    depends_on:
      - server
      
  # --- 3. CLIENTE TCP (Para Interação e Teste) ---
  client:
    build: 
      context: .
      dockerfile: Dockerfile.base
    container_name: tcp-client
    # Configurações para manter o terminal interativo (necessário para digitar)
    stdin_open: true 
    tty: true        
    depends_on:
      - proxy
    # O comando é sleep; a execução do teste será manual via docker exec
    command: sleep infinity